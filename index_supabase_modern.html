<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>CampusMove</title>
  <meta name="theme-color" content="#059669"/>
  <link rel="manifest" href="/manifest.webmanifest"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/env.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    :root{ --cm:#059669; --cm2:#10b981; }
    .glass { backdrop-filter: blur(8px); background: rgba(255,255,255,0.8); }
    .pill { border:1px solid #e5e7eb; border-radius:999px; padding:.4rem .8rem; display:inline-block; }
    .btn  { background:var(--cm); color:#fff; padding:.6rem .9rem; border-radius:.75rem; font-weight:600; }
    .btn:disabled{ opacity:.5; cursor:not-allowed }
  </style>
</head>
<body class="bg-gradient-to-b from-emerald-50 to-teal-50 text-gray-900">
  <header class="sticky top-0 z-20 border-b bg-white/70 backdrop-blur">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-2xl grid place-items-center font-extrabold text-white" style="background:var(--cm)">CM</div>
        <div>
          <div class="text-xs text-gray-500 -mb-1">Bienvenue</div>
          <div class="font-semibold" id="cm-username">Ziaratou</div>
        </div>
      </div>
      <nav class="hidden md:flex gap-2" id="cm-tabs"></nav>
    </div>
  </header>

  <section class="max-w-6xl mx-auto px-4 mt-6">
    <div class="rounded-2xl border border-emerald-200 bg-gradient-to-r from-emerald-100 to-teal-100 p-6">
      <div class="flex flex-col md:flex-row items-center gap-6">
        <div class="flex-1">
          <div class="text-emerald-700 text-xs font-semibold uppercase tracking-wider flex items-center gap-2">
            <span class="w-2 h-2 bg-emerald-600 rounded-full"></span> CampusMove
          </div>
          <h1 class="text-3xl md:text-4xl font-extrabold mt-1">Ta mobilit√© plus simple, plus verte üå±</h1>
          <p class="text-gray-700 mt-2">Covoiture, p√©dale ou prends le bus ‚Äî l'app calcule le meilleur trajet et suit tes √©conomies de CO‚ÇÇ.</p>
          <div class="mt-3 flex flex-wrap gap-2">
            <span class="pill">‚àí70% d'√©missions</span>
            <span class="pill">Badges & objectifs</span>
            <span class="pill">Alertes temps r√©el</span>
          </div>
        </div>
        <div class="glass rounded-xl p-5 border border-emerald-100 shadow text-center">
          <div class="text-6xl">üö≤</div>
          <div class="text-sm font-semibold mt-2">Itin√©raires v√©lo</div>
        </div>
      </div>
    </div>
  </section>

  <main class="max-w-6xl mx-auto px-4 py-6">
    <div class="md:hidden mb-3 flex flex-wrap gap-2" id="cm-tabs-mobile"></div>
    <div id="view-carpool" class="space-y-3"></div>
    <div id="view-routes"  class="hidden space-y-3"></div>
    <div id="view-emissions" class="hidden space-y-3"></div>
    <div id="view-planning" class="hidden space-y-3"></div>
    <div id="view-alerts" class="hidden space-y-3"></div>
  </main>

  <footer class="max-w-6xl mx-auto px-4 pb-10 text-center text-sm text-gray-500">
    CampusMove ¬∑ Connect√© √† Supabase ¬∑ ¬© <span id="y"></span>
  </footer>

  <script type="module">
    document.getElementById('y').textContent = new Date().getFullYear();

    const TABS = [
      { id:'carpool',   label:'Covoiturage', icon:'üöó' },
      { id:'routes',    label:'Itin√©raires', icon:'üß≠' },
      { id:'emissions', label:'√âmissions',   icon:'üåç' },
      { id:'planning',  label:'Planning',    icon:'üìÖ' },
      { id:'alerts',    label:'Alertes',     icon:'üîî' },
    ];
    const tabsHTML = TABS.map(t => `<button data-tab="${t.id}" class="pill hover:bg-gray-50">${t.icon} ${t.label}</button>`).join('');
    document.getElementById('cm-tabs').innerHTML = tabsHTML;
    document.getElementById('cm-tabs-mobile').innerHTML = tabsHTML;
    function setTab(id){
      for(const t of TABS){
        document.getElementById('view-'+t.id).classList.toggle('hidden', t.id!==id);
        [...document.querySelectorAll('[data-tab="'+t.id+'"]')].forEach(b=>{
          if(t.id===id){ b.classList.add('bg-emerald-600','text-white','border-emerald-600'); }
          else{ b.classList.remove('bg-emerald-600','text-white','border-emerald-600'); }
        });
      }
      localStorage.setItem('cm_tab', id);
    }
    [...document.querySelectorAll('[data-tab]')].forEach(b => b.addEventListener('click', e => setTab(e.currentTarget.dataset.tab)));
    setTab(localStorage.getItem('cm_tab') || 'carpool');

    // SUPABASE
    const { createClient } = supabase;
    const supa = createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);

    const RESIDENCES = ["Centre-ville","Quartier Avenir","R√©sidence Atlas","Oasis","Sidi Maarouf"];
    const CAMPUS = "Campus";
    const CO2 = { walk:0, bike:0, bus:0.089, carSolo:0.192, carShare:0.07 };
    const KM = { "Centre-ville":6.2, "Quartier Avenir":4.7, "R√©sidence Atlas":3.1, "Oasis":5.4, "Sidi Maarouf":7.8 };

    async function loadOffers(from, to=CAMPUS){
      const { data, error } = await supa.from('offers').select('*').eq('from', from).eq('to', to).order('time',{ascending:true});
      if(error){ console.error(error); return []; }
      return data||[];
    }
    async function publishOffer({driver, from, to=CAMPUS, time, seats, note}){
      const { data, error } = await supa.from('offers').insert([{ driver, from, to, time, seats, note }]).select();
      if(error) throw error;
      return data[0];
    }
    async function bookOffer(offer, userName){
      const { data, error } = await supa.from('offers')
        .update({ seats: offer.seats - 1 })
        .eq('id', offer.id)
        .gt('seats', 0)
        .select();
      if(error) throw error;
      if(!data || !data.length) return { ok:false, reason:'FULL' };
      const { error:e2 } = await supa.from('bookings').insert([{ offer_id: offer.id, user_name: userName }]);
      if(e2) throw e2;
      return { ok:true };
    }

    async function seedIfEmpty(){
      const { data } = await supa.from('offers').select('id').limit(1);
      if(data && data.length) return;
      const demo = [
        { driver:'Imane',   from:'Oasis',        to:CAMPUS, time:'07:45', seats:2, note:'D√©part boulangerie' },
        { driver:'Youssef', from:'Centre-ville', to:CAMPUS, time:'08:10', seats:3, note:'Porte nord' },
        { driver:'Hassan',  from:'Sidi Maarouf', to:CAMPUS, time:'08:00', seats:1, note:'Station tram T3' },
      ];
      await supa.from('offers').insert(demo);
    }
    await seedIfEmpty();

    // UI blocks
    const viewCarpool = document.getElementById('view-carpool');
    function card(inner){ return `<div class='rounded-xl border bg-white p-4'>${inner}</div>`; }
    let currentResidence = localStorage.getItem('cm_res') || 'R√©sidence Atlas';
    function setResidence(v){ currentResidence = v; localStorage.setItem('cm_res', v); }

    async function renderCarpool(){
      const head = `
      <div class="rounded-2xl border p-4 bg-white">
        <h2 class="text-xl font-bold mb-2">Trouver un trajet</h2>
        <div class="grid md:grid-cols-4 gap-3">
          <div>
            <label class="text-sm text-gray-600">D√©part</label>
            <select id="fromSel" class="w-full border rounded-lg p-2">
              ${RESIDENCES.map(r=>`<option ${r===currentResidence?'selected':''}>${r}</option>`).join('')}
            </select>
          </div>
          <div>
            <label class="text-sm text-gray-600">Arriv√©e</label>
            <input value="${CAMPUS}" class="w-full border rounded-lg p-2 bg-gray-100" disabled/>
          </div>
          <div>
            <label class="text-sm text-gray-600">Heure (indicative)</label>
            <input id="timeSel" type="time" class="w-full border rounded-lg p-2"/>
          </div>
          <div class="flex items-end">
            <button id="btnSearch" class="btn w-full">Rechercher</button>
          </div>
        </div>
      </div>`;

      const offers = await loadOffers(currentResidence);
      let list = "";
      if(!offers.length){
        list += card(`<div class="text-gray-600">Aucune offre depuis <b>${currentResidence}</b> pour le moment.</div>`);
      }else{
        list += offers.map(o => card(`
          <div class="flex items-center justify-between">
            <div>
              <div class="font-semibold">${o.driver} ¬∑ ${o.time}</div>
              <div class="text-sm text-gray-600">${o.from} ‚Üí ${o.to} ¬∑ ${o.seats} place(s)</div>
              ${o.note? `<div class="text-sm text-gray-500 mt-1">${o.note}</div>` : ""}
            </div>
            <button class="btn" data-book="${o.id}" ${o.seats<=0?'disabled':''}>${o.seats>0?'R√©server':'Complet'}</button>
          </div>
        `)).join('');
      }

      const pub = card(`
        <h3 class="font-semibold mb-2">Proposer un trajet</h3>
        <div class="grid md:grid-cols-5 gap-2">
          <select id="pf_from" class="border rounded-lg p-2">${RESIDENCES.map(r=>`<option ${r===currentResidence?'selected':''}>${r}</option>`).join('')}</select>
          <input id="pf_time" type="time" class="border rounded-lg p-2"/>
          <input id="pf_seats" type="number" min="1" max="4" value="1" class="border rounded-lg p-2"/>
          <input id="pf_note" placeholder="Point de RDV, info‚Ä¶" class="border rounded-lg p-2"/>
          <button id="pf_btn" class="btn">Publier</button>
        </div>
      `);

      viewCarpool.innerHTML = head + list + pub;

      document.getElementById('fromSel').addEventListener('change', async (e)=>{ setResidence(e.target.value); renderCarpool(); });
      document.getElementById('btnSearch').addEventListener('click', async ()=> renderCarpool());
      document.getElementById('pf_btn').addEventListener('click', async ()=>{
        const from = document.getElementById('pf_from').value;
        const time = document.getElementById('pf_time').value || '08:00';
        const seats = parseInt(document.getElementById('pf_seats').value||'1',10);
        const note = document.getElementById('pf_note').value;
        const driver = document.getElementById('cm-username').textContent || '√âtudiant¬∑e';
        await publishOffer({ driver, from, time, seats, note });
        alert('Offre publi√©e ‚úÖ');
        renderCarpool();
      });
      document.querySelectorAll('[data-book]').forEach(btn => btn.addEventListener('click', async e => {
        const id = e.currentTarget.getAttribute('data-book');
        const offers = await loadOffers(currentResidence);
        const o = offers.find(x=>x.id===id);
        if(!o) return;
        const res = await bookOffer(o, document.getElementById('cm-username').textContent);
        if(res.ok){
          const savedKg = (KM[o.from]||4.5) * (CO2.carSolo-CO2.carShare);
          localStorage.setItem('cm_saved', String((parseFloat(localStorage.getItem('cm_saved')||'0') + savedKg).toFixed(2)));
          alert(`R√©serv√© ‚úÖ  (+${savedKg.toFixed(2)} kg CO‚ÇÇe)`);
          renderCarpool();
          renderEmissions();
        }else{
          alert('D√©sol√©, plus de place üòû');
          renderCarpool();
        }
      }));
    }

    const viewRoutes = document.getElementById('view-routes');
    function renderRoutes(){
      const r = localStorage.getItem('cm_res') || 'R√©sidence Atlas';
      const d = (KM[r]||4.5);
      const walk = Math.round(d/4.5*60);
      const bike = Math.round(d/15*60);
      const car  = Math.round(d/28*60);
      viewRoutes.innerHTML = [
        card(`<b>V√©lo direct</b><br/><span class="text-gray-600">${d.toFixed(1)} km ¬∑ piste cyclable</span><br/>${bike} min ¬∑ <span class="text-gray-500">0.00 kg CO‚ÇÇe</span>`),
        card(`<b>Marche</b><br/><span class="text-gray-600">${d.toFixed(1)} km</span><br/>${walk} min ¬∑ <span class="text-gray-500">0.00 kg CO‚ÇÇe</span>`),
        card(`<b>Covoiturage</b><br/><span class="text-gray-600">${d.toFixed(1)} km partag√©</span><br/>${car} min ¬∑ <span class="text-gray-500">${(d*CO2.carShare).toFixed(2)} kg CO‚ÇÇe</span>`),
      ].join('');
    }

    const viewEmissions = document.getElementById('view-emissions');
    function renderEmissions(){
      const goal = 10;
      const saved = parseFloat(localStorage.getItem('cm_saved')||'0');
      const pct = Math.min(100, Math.round(saved/goal*100));
      viewEmissions.innerHTML = card(`
        <h2 class="text-xl font-bold mb-2">Objectif hebdomadaire</h2>
        <div class="w-full h-3 bg-gray-100 rounded-full overflow-hidden mb-2">
          <div class="h-3" style="width:${pct}%; background:linear-gradient(90deg,var(--cm),var(--cm2))"></div>
        </div>
        <div class="text-sm text-gray-600">${saved.toFixed(2)} / ${goal} kg CO‚ÇÇe √©vit√©s</div>
        <div class="mt-3 text-sm">
          <span class="pill">Badge ‚ÄúD√©brouillard¬∑e‚Äù</span>
          <span class="pill">Badge ‚Äú√âconome‚Äù</span>
          <span class="pill">Badge ‚ÄúAmbassadeur¬∑rice‚Äù</span>
        </div>
      `);
    }

    document.getElementById('view-planning').innerHTML = card(`<b>Horaires de cours</b><br/>Lun 08:30‚Äì12:00 ¬∑ Mar 10:00‚Äì16:00 ¬∑ Mer 09:00‚Äì13:00`);
    document.getElementById('view-alerts').innerHTML   = card(`<b>Alertes</b><br/>M√©t√©o : Pluie demain matin. ¬∑ Trafic : Ralentissement N11 8h-9h.`);

    await renderCarpool();
    renderRoutes();
    renderEmissions();
  </script>
</body>
</html>
